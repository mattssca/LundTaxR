---
title: "Data Retrieval and Utility Workflows"
author: "Adam Mattsson"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 3
    number_sections: true
    fig_width: 8
    fig_height: 6
    fig_caption: true
vignette: >
  %\VignetteIndexEntry{Data Retrieval and Utility Workflows}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "figures/",
  out.width = "100%",
  warning = FALSE,
  message = FALSE
)

# Load required packages
library(LundTaxR)
library(knitr)
library(dplyr)
```

# Introduction

This vignette demonstrates how to efficiently retrieve, filter, and summarize classification results using LundTaxR’s utility functions. After classifying samples, you often need to extract specific subsets, order samples for visualization, or compute summary metrics for downstream analysis. LundTaxR provides a suite of helper functions to streamline these common tasks.

## What’s Covered

In this vignette, you’ll learn how to:

- **Extract subsets of predictions** for specific sample groups using `get_prediction_subset`
- **Order samples** based on subtype, score, or other criteria with `get_sample_order`
- **Compute and interpret subtype metrics** using `get_subtype_metrics` for summary statistics and quality control

Each section includes practical code examples that you can adapt to your own data and workflows.

---

## 1. Extracting Prediction Subsets with `get_prediction_subset`

After classifying your samples, you may want to focus your analysis on a specific subset of samples—such as those belonging to a particular group or cohort. The `get_prediction_subset` function is designed to help you do just that: it extracts only the relevant samples from all components of your prediction results, whether those components are data frames or named vectors.

You can specify the samples to keep either by providing a vector of sample IDs, or by passing a metadata data frame that contains the desired samples. The function will return a new predictions list, but restricted to just the samples you specified.

### Example: Subsetting by Sample IDs

Suppose you want to examine only a handful of samples from your classification results:

```{r subset-by-ids}
# Run the classifier (if not already done)
data("sjodahl_2017")
data("sjodahl_2017_meta")
results <- classify_samples(
  this_data = sjodahl_2017,
  include_data = TRUE,
  verbose = FALSE
)

# Select a few sample IDs
selected_samples <- head(sjodahl_2017_meta$sample_id)

# Subset the results to just these samples
subset_results <- get_prediction_subset(
  these_predictions = results,
  these_sample_ids = selected_samples
)

# View the subsetted data
head(subset_results$data)
head(subset_results$subtype_scores)
head(subset_results$predictions_5classes)
```

### Example: Subsetting by Metadata

Alternatively, you can subset your results using a metadata data frame. This is useful if you have filtered your metadata for a specific group (e.g., only tumor samples, or only a certain clinical stage):

```{r subset-by-metadata}
# Take a subset of the metadata
meta_subset <- head(sjodahl_2017_meta)

# Subset the results using the metadata
subset_results_meta <- get_prediction_subset(
  these_predictions = results,
  these_samples_metadata = meta_subset,
  samples_rownames = FALSE
)

# View the subsetted data
head(subset_results_meta$data)
```

## 2. Ordering Samples by Proliferation Score with `get_sample_order`

When visualizing or analyzing your classification results, it’s often helpful to arrange samples in a biologically meaningful order. The `get_sample_order` function provides a convenient way to sort your samples based on their proliferation score, specifically the late/early gene expression ratio. Note, this is the implemented sample order
that is shown in the `plot_classification_heatmap`.

This function is especially useful for downstream plotting, as it returns a vector of sample names ordered by their proliferation status. You can use this order to consistently arrange samples in heatmaps or other visualizations.

### Example: Ordering by Late/Early Ratio

To use `get_sample_order`, make sure you ran `classify_samples` with `include_data = TRUE` so the expression data is available:

```{r sample-order}
# Get the sample order based on late/early ratio (default)
ordered_samples <- get_sample_order(expr_data = results$data)
head(ordered_samples)

# If you want the actual late/early ratio values instead of the order:
late_early_ratios <- get_sample_order(expr_data = results$data, return_this = "late_early")
head(late_early_ratios)
```

This ordering can be used directly in plotting functions or to structure your data for further analysis, ensuring that samples are consistently arranged by their proliferation characteristics.

## 3. Summarizing Subtype Metrics with `get_subtype_metrics`

Understanding how clinical or experimental variables are distributed across molecular subtypes is a key part of downstream analysis. The `get_subtype_metrics` function makes it easy to tabulate and summarize metadata variables (such as gender, survival events, or other annotations) by subtype classification.

This function works by matching sample IDs between your metadata and prediction results, then counting the number of samples for each subtype and each level of your chosen metadata variable. You can focus on a specific value (e.g., only males, or only events) or get a full breakdown for all levels.

### Example: Counting Events by Subtype

Suppose you want to see how many progression events occurred in each subtype:

```{r subtype-metrics-events}
# Run the classifier if not already done
results <- classify_samples(
  this_data = sjodahl_2017,
  include_data = TRUE,
  verbose = FALSE
)

# Tabulate survival events (e.g., "surv_os_event" column)
metrics_events <- get_subtype_metrics(
  these_predictions = results,
  this_metadata = sjodahl_2017_meta,
  this_metadata_variable = "surv_os_event",
  factor_level = 1
)
knitr::kable(metrics_events)
```

### Example: Summarizing Gender Distribution

You can also use this function to summarize categorical variables, such as gender:

```{r subtype-metrics-gender}
metrics_gender <- get_subtype_metrics(
  these_predictions = results,
  this_metadata = sjodahl_2017_meta,
  this_metadata_variable = "gender",
  factor_level = "Male"
)
knitr::kable(metrics_gender)
```

This approach helps you quickly assess the distribution of key variables across subtypes, supporting both quality control and hypothesis generation in your analyses.